import os
import sys
import numpy as np
import pandas as pd
import pytest

# adding directory to the system path of python script
sys.path.insert(0, os.path.join(os.path.abspath(os.path.dirname(__file__)), '../python_script'))
import lib.utility_lib as Util
import va_enrich_report_generator as Generator
from step_definition.step_data import StepData

# Configuration file
CONFIG_PROPERTY_FILE = './config_properties.yml'

# Input file
INPUT_PARAMETERS = "testsuite/input_parameters.yml"

PATH = os.path.join('python_script/va_enrich_report_generator')


@pytest.fixture(scope="module", autouse=True)
def global_var():
    base_image_table = Util.get_df_from_spreadsheet_file(os.path.join('testsuite/testData', 'empty_base_image.csv'))
    pytest.base_image_table = base_image_table.copy()


def test_success_StepSetTeamColumnReorder(global_var):
    print(Util.colour_text(Util.MyColours.BLUE,
                           "*************************************************************************************\n"))

    va_repo_actual = {
        'CXP Resp.Team': ['CXP_A', 'None', 'CXP_C', 'CXP_D'],
        'RA SG tab': ['A', 'None', 'C', 'D'],
        'Team SG mapping tab': ['A', 'None', 'C', 'D'],
        'RA CXP tab': ['A', 'B', 'C', 'D'],
        'CNA SG tab': ['A', 'B', 'C', 'D'],
        'CNA CXP tab': ['A', 'B', 'C', 'D']
    }

    va_repo_expected = {
        'CXP Resp.Team': ['CXP_A', 'CXP_C', 'CXP_D'],
        'RA SG tab': ['A', 'C', 'D'],
        'Team SG mapping tab': ['A', 'C', 'D'],
        'RA CXP tab': ['A', 'C', 'D'],
        'CNA SG tab': ['A', 'C', 'D'],
        'CNA CXP tab': ['A', 'C', 'D']
    }

    va_repo_actual_table = pd.DataFrame(va_repo_actual)
    va_repo_expected_table = pd.DataFrame(va_repo_expected)
    step_info = StepData(va_repo_actual_table, pytest.base_image_table)
    va_report_set_column_reorder_df = Generator.StepSetTeamColumnAndReorder(step_info)
    va_report_set_column_reorder_df.run_step()
    new_va_report = step_info.get_curr_va_report_df

    va_repo_expected_table.reset_index()
    new_va_report.reset_index()
    df = pd.merge(va_repo_expected_table, new_va_report, left_on= ['CXP Resp.Team', 'RA SG tab'], right_on= ['Team', 'RA'], how = 'inner')
    assert len(df) == len(va_repo_expected_table)
