import os
import sys

import pandas as pd
import pytest

# adding lib directory to the system path of python script


sys.path.insert(0, os.path.join(os.path.abspath(os.path.dirname(__file__)), '../python_script/lib'))
import lib.utility_lib as Util

# adding py_script directory to the system path of python script
sys.path.insert(0, os.path.join(os.path.abspath(os.path.dirname(__file__)), '../python_script'))
from step_definition.step_data import StepData
from step_impl.step_add_cxp import StepAddCxp

# Input file
INPUT_PARAMETERS = "testsuite/input_parameters.yml"



@pytest.fixture(scope="module", autouse=True)
def global_var():
    va_repo_table = Util.get_df_from_spreadsheet_file(os.path.join('testsuite/testData', 'va_report_input_step3.csv'))
    va_repo_table = va_repo_table.reset_index(drop=True)
    pytest.va_repo_table = va_repo_table.copy()


def test_success_step_2():
    df_rpm_associations = \
        Util.config_file_to_dictionary('./path_2_rpm_associations.yml', 'path_2_rpm_associations')
    pytest.va_repo_table['Check_Condition'] = 'OK'
    for key, val in df_rpm_associations.items():
        pytest.va_repo_table.loc[pytest.va_repo_table['Package Paths'].str.startswith(key) &
                                 (pytest.va_repo_table['Rpm Package'] == 'None'), 'Check_Condition'] = "NOT_OK"
    print(pytest.va_repo_table)
    step_info = StepData(pytest.va_repo_table, pd.DataFrame())
    step_add_cxp = StepAddCxp(step_info)
    step_add_cxp.run_step()
    df_result = step_add_cxp._step_data.get_curr_va_report_df
    print(df_result.count)
    df_result['Result'] = 'OK'
    for key, val in df_rpm_associations.items():
        df_result.loc[df_result['Package Paths'].str.startswith(key) &
                      (df_result['Rpm Package'] == 'None'), 'Result'] = "NOT_OK"
        df_result.loc[df_result['Package Paths'].str.startswith(key) &
                      (df_result['Rpm Package'] != val), 'Result'] = "NOT_OK"
    print(df_result.count)
    assert len(df_result[df_result['Result'] != 'OK']) == 0, "ERROR!"
