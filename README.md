# CVE JIRA Task Generator

[TOC]

## Introduction - Background

When scan of vulnerabilities for ENM product was implemented there was a huge number of CVEs to urgently fix. That's deals to the need:

* To track vulnerability fixing.
* To give as much information as possible to developer for fixing it quickly.
* To remove duplications as the same CVE is detected by multiple scan tools and sometimes refers to a common library or module widely used.
* To address to the proper responsible team the CVEs.

## Identified Solution

* Introduce a new type of JIRA ticket, named 'vulnerability'.
* Define a JIRA vulnerability tickets LCM.
* Automatically open JIRA 'vulnerability' tickets on a " CVE - 3pp - image/rpm" bases.
* Assign the JIRA vulnerability ticket to a responsible team for that specific image/rpm.
* Enrich the scan tools output with RPM information.

As scan tools generate output in xlsx and csv format, considering the initial amount of CVEs found was huge, it was decided to:

* Use python language and in particular pandas library for elaborating the scan tools output and produce a CSV file suitable to be imported in JIRA.
* Use as much as possible Ericsson DBs (PRM/TI/JIRA) to get the information about responsible team, RA and CNA to open JIRA vulnerability tickets.
* Use official Ericsson DBs (PRM) to match information about CXP name with team name and keep it update.
* As scan tools work on docker images, add a table manually built for matching image name with team name whenever the CXP information is not available, as PRM or other DBs doesn't contains reliable information about it.
* Integrate the CI script for generating JIRA vulnerability tickets and LCM (this was done lately).

The result is a set of 5 python scripts (plus additional libraries files) for achieving this target:

* Defined in **python_script** directory: main.py, input_table_pre_analysis.py, va_enrich_report_generator.py, csv_for_jira_generator.py
* Defined in **utility** directory: check_prm_data.py - it can also be used as a standalone script for fixing PRM problems.

## Precondition

Copy on folder 'input_table' the required version of the scan report and correspondent base image generated by Ericsson official scan tools

Set the 'config_properties.yml' according to the following link:
<https://eteamspace.internal.ericsson.com/display/DEVAREA/YAML+configuration+files+content+description>

For usage and further details, see the following link:
<https://eteamspace.internal.ericsson.com/display/DEVAREA/CVE+generator+script+-+Instructions+for+usage+and+configuration>

## Source Code Overview - Repository and Directory Structure

The root project directory contains the following files:

* config_properties.yml: The configuration file of the scripts.
* logging.yaml: The configuration file of the logger.
* Dockerfile: The dockerfile previously used in pipeline environment.
* path_2_rpm_associations.yml: This file just contains static associations.
* config_jira_filler.py: See **Update configuration file - config_jira_filler.py** section for more details.
* README.md

**Subdirectories:**

1. **cve_auto_task_script** Contains the source code for CI script for generating JIRA vulnerability tickets. (See **JIRA Ticket generation CI script - cve_auto_task_script** section for more details)
2. **db_input_tables:** Initially contains 2 files **CXP_Table.csv** and **SG_Mapping_Table.csv**. It is also used for downloading data from TI/PRM/JIRA.
    * **CXP_Table.csv**

        This file match the unique CXP identifier of the RPM package affected by the vulnerability with a responsible team according to the information available in Ericsson PRM DB. It also highlight the presence in the va report of missing CXP that prevents opening CVE JIRA vulnerability.

        That's permit to keep data of **CXP_Table.csv** automatically updated every time we launch the scripts.

        The CXP identifier is retrieved by the RPM package name. The RPM package name information is not provided in scan reports, as the scan tools works on docker images and so they only know about them. However we added an ancillary script, run during scan execution, which, in most situations, is able to identify the RPM from the Package Path information provided by scan tools.
    * **SG_Mapping_Table.csv**

        Unfortunately the scan tools sometimes are not able to give a Package Path useful for identifying the RPM, so the scripts can't process these rows, and as a consequence, no JIRA vulnerability ticket is open as a consequence.

        That's a problem because customer do their scan and will detect a vulnerability that nobody is working on and that is not traceable.

        We investigate if there is any place or DB in Ericsson where to find information about the image names and the responsible team for that image, but nothing exists at the moment.
        So we manually filled this file searching information in PRM (sometimes trying to "guess it") or contacting CNAs, RA responsible, etc. and adding it new entries when we are able to find a responsible team.

        In case the matching team becomes obsolete, we are usually informed of it via e-mail and manually update the table.
3. **input_tables:** Initially contains 1 default input file named empty_base_image.xlsx. You have to copy scan report output files here.
4. **python_script:** Subdirectories contains the python scripts and library, included the **main.py** script.
5. **testsuite directory:** Contains a set of tests written using pytest library for verifying the source code changes. Also includes required files to setup the tests such as the test data files found in **testData** directory. The information how run the tests (test cases) and information about test cases is found README.md file in this directory.
6. **utility:** Contains **check_prm_data.py** script and other scripts to be launched standalone too. The **check_prm_data.py** script provides a function for updating **CXP_Table.csv** file with valid information downloaded from PRM, but can also be used to analyze all problems of PRM if launched standalone.

## Scripts Information

### Input files

1. Table elaborated from Ericsson DB tables where we have some static information manually updated or including additional information - **SG_Mapping_Table.csv**, **path_2_rpm_associations.yml**.
2. Tables downloaded from Ericsson DBs (PRM/TI) including information for matching CXP and team Name properly - **CXP_Table.csv**.
3. VA reports coming from 3 Ericsson official scan tools (grype, trivy, xray) output, merged into a unique file.
4. **config_properties.yml** file, updated with information required for the scripts. (see **Update configuration file - config_jira_filler.py** section for more information on script automation of updating this file)

### Launcher for all scripts - main.py

Main script it is the launcher for all scripts involved in the process of generating the expected output (va scan report enriched, csv file to be imported in JIRA) and for updating/downloading the DB input tables to enrich scan report information.

It launches the scripts/library functions described in the following chapters and stop execution whenever a script fails, avoiding to launch the next one.

Some scripts are executed only under condition set in the **config_properties.yml** file.

Summarising:

1. Check va scan reports file existence.
2. Download TI table information and save it in **db_input_tables** directory.
3. Download from JIRA team, RA and CNA information and save it in **db_input_tables** directory.
4. Download PRM.
5. Update CXP table with valid data from PRM execute (in this order):
    * **input_table_pre_analysis.py**
    * **va_enrich_report_generator.py**
    * **csv_for_jira_generator.py**

### CXP table update script - check_prm_data.py

The CXP table update task is executed according to the value of the boolean **update_cxp_table_with_prm_data** tag (by default set to True), in config property file, using the library function **check_and_apply_prm_data** exported by check_prm_data.py script located in utility directory.

The output produced by this function is an updated CXP table and information about missing CXP if any.

For further details see:  Check and apply PRM data - Instruction for usage and configuration of **check_prm_data.py** script: <https://eteamspace.internal.ericsson.com/display/DEVAREA/Check+and+apply+PRM+data+-+Instruction+for+usage+and+configuration+of+check_prm_data.py+script>

### Pre-process script - input_table_pre_analysis.py

This script was introduced to sanitize the input from scan tools that might contains error or ambiguous information that can't be processed and to clean up the db input tables. It generates as output cleaned va and base image table to be enriched by the **va_enrich_report_generator.py** script

In particular it:

* Analyzes the scan reports (base image and va report) in **all_images_final_report_remove_unprocessing** function, for use cases from 1 to 5 detailed in **Unprocessed CVE Management**.
* Save the analyzed input tables into **clean_input_tables** directory with same name.
* Remove duplicates both in SG mapping table and CXP table.
* Replace the SG and CXP table team name information with the string in TI table and save both tables in **clean_db_input_tables** directory.

### Enrich va scan report script - va_enrich_report_generator.py

Input to this script is the output of the pre-process script saved in **clean_input_tables** directory. The va report and base image filename are the ones defined in **config_properties.yml** file.

This script executes a steps chain in the correct order.

Depending on the specific tasks carried on by the step, the execution order can be changed or not.

It simplify the operation of removing or adding a new step to the chain.

#### Step Class

##### Definition

The abstract base class from which all steps class are derived from is named **StepInterface**. It exposes an abstract method execute to be implemented in the derived classes for executing the tasks performed by the implementation step (filter by severity, add the RPM columns, etc.).

It uses **StepData** class which is basically a structure containing all the attributes for storing the input and output data of each step and getter and setter of its attributes.

##### Implementation

All steps are implementation class for the abstract **StepInterface** class.

Step implementation class, defines one or more private method for modifying the scan report according to its purpose, to be executed in execute method implementation.

A special implementation class named **StepCommon** implements python class method used by more than one implementation class.

Some steps needs to operate on multiple dataframes other than the scan report, for adding specific information from CXP table or SG mapping table. So, the step constructor in some cases doesn't have the same signature as the original **StepInterface** class one (in python that means redefine the **_init_** constructor method and call the superclass constructor).

Optionally the step implementation can override the validate method for checking the output of the elaboration process was successful and no errors occurs, stopping execution if required.

Overriding of **get_execution_results** method inside a step definition can be used to return additional information produced by the specific step of whatever type as a generic python Tuple.

Each step execute usually a single or maximum two operations and generate the updated va report/base image to be used by next step. The code the step executes is defined internally to the class as private method, unless it uses library function only. The name of the class briefly describe the operation executed.

##### Relationship

Overview single step class tasks

The steps do the following operation in the following order:

1. **StepFilterBySeverity:** Filter va scan report on the severities specified in the **config_properties.yml** file.
2. **StepExpandRows:** Expand the multiple content of the 'Rpm Name', 'Package Path' and 'Found In' columns into multiple rows.
3. **StepAddCxp:** For Packages Path values matching the correspondent value in **path_2_rpm_associations.yml**, get the Rpm Name and add it to the input table. **path_2_rpm_associations.yml** information were manually identified.
4. **StepRemoveBaseImageRow:** Remove base image report rows containing a valid 'Rpm Name' from the va scan report.
5. **StepAddRpmInfoColumns:** Add 2 columns values for CXP and RPM version extracted from the 'Rpm Name' (if present).
6. **StepAddTeamRaCna:** Add columns for Team and RA taken from **SG_Mapping_Table.csv** (matching on image name) and other similar one taken from **CXP_Table.csv** (if CXP is available). A following step will discriminate between the Team and RA columns added according to the presence of a CXP.
7. **StepSwapCveWithVid:** Swap the row content of the 'VulnerabilityID' column, whenever the 'CVE REF' column contains multiple CVE IDs.
8. **StepRemoveDuplicates:** Remove duplicated rows. This step should be ran after **StepSwapCveWithVid**.
9. **StepSwapCveNoneWithVid:** Whenever the 'CVE REF' column doesn't contains a valid value and the 'VulnerabilityID' column one does, we take the value from 'VulnerabilityID' column.
10. **StepSetTeamColumnAndReorder:** If a valid CXP is available, it takes the team name from **CXP_Table.csv**, otherwise it uses the one from **SG_Mapping_Table.csv**. Once done, the new final 'Team' column is created with the processed value. In case it doesn't contain a valid value for team or RA, the rows is moved to the unprocessed data as no JIRA vulnerability ticket can be open without a valid Team and RA name.
11. **StepRemoveUnusedColumnAndReorder:** This step clean-up of added work columns not required anymore.
12. **StepRemoveTeamAndRaNotAvailableOnJira:** Even if team and RA are set, it may happens that JIRA DB is not aligned to TI/PRM DB. That's another case where it is not possible to open the JIRA vulnerability, so we moved these rows to unprocessed file.
13. **StepSaveUnprocessedData:** Once the processing of va report data is completed, all the removed rows for various reasons are collected and saved in the unprocessed file.
14. **StepCheckUnprocessedCxpSg:** This step reports the list of unprocessed CVEs due to the lack of a valid CXP in **CXP_Table.csv** or a valid SG in **SG_Mapping_Table.csv**. This report is useful to try to recover these CVEs completing manually with missing data the **SG_Mapping_Table.csv** or asking to prioritize the introduction in PRM of the missing CXP required for managing the CVE.
15. **StepMergeLinesOnTool:** The CVE can be detected by one or more of the 3 approved scan tools (grype, xray, trivy). In the JIRA ticket this information split into 3 columns (one for each tool) is collapsed into one line. This step prepare a unique column for this purpose - merge on tool ('Found In' column) and clean unnamed columns.

### Update configuration file - config_jira_filler.py

This script injects Jenkins build parameters into the configuration file for Jira generation script.
It relies on configuration file (config_properties.yml) located in Gerrit repository:

OSS/ENM-Parent/SQ-Gate/OSS/com.ericsson.de.execution/cve-jira-task-generator

It has to be launched inside a Python Virtualenv:

* Python version: 3.11.0
* Python modules: <https://gerrit-gamma.gic.ericsson.se/gitweb?p=OSS/ENM-Parent/SQ-Gate/com.ericsson.va/oss_va.git;a=blob_plain;f=requirements_311.txt>

```text
. /home/axisadm/cENM_va/311env/bin/activate
python config_jira_filler.py <config_file_name> <ENM Product Set> <Jira generation>
```

**Note:**  All Arguments are strings.

* Required: config_file_name i.e config_properties.yml
* Required: ENM Product Set e.g 24.07.115
* Optional: Jira generation - 'True' or 'False' (default 'False')

References: <https://eteamspace.internal.ericsson.com/display/DGBase/Vulnerability+Analysis+Full+Scan+Reporting+for+Jira+generation>

### CSV file for JIRA vulnerability ticket generation - csv_for_jira_generator.py

This script manages the data from the report produced by the script **va_enrich_report_generator.py** and produced a new "csv" file that can be managed by the **cve_auto_task_script** to open the Jira tickets.

In details the script executes the following operations:

* Loads the VA report output file.
* Loads the property configuration file i.e **config_properties.yml**.
* Combining the data from the VA report and adding new columns.
* Remove unused columns and order the columns to generate the output file.
* Save the output file in the .csv and .xlsx (Excel) formats.

### JIRA Ticket generation CI script - cve_auto_task_script

This is an external script, written by CI team, for generating JIRA tickets, that we simply launch passing it the "csv" file generated by our scripts. It also manages the LCM of JIRA ticket and in particular is responsible for re-opening closed tickets for CVEs re-detected by the scan it refers too (wrongly fixed).

The source code is stored in **cve_auto_task_script** subdirectory of the **cve-jira-task-generator** project.

The directory includes 3 python scripts:

* **jira.py**
* **logger.py**
* **main.py**

**main.py** is main script use to launched the other 2 scripts in this directory.

## Result Information

The **cve-jira-task-generator** results are 4 files, which are found in the **output_tables** directory.
If Jira generation was set to 'True' for **cve_auto_task_script**: The CVE JIRA 'Vulnerability' tickets are created or updated on demand automatically.

### Output files

Found in the **output_tables** directory.

The files will have the following naming convention:

* cENM-cve-jira-csv_<enm_product_set>_<date_time>.csv: CSV Version of the file ready to be processed by JIRA.
* cENM-cve-jira-csv_<enm_product_set>_<date_time>.xlsx: XLSX Version of the file ready to be processed by JIRA.
* cENM-va-report-for-jira_<enm_product_set>_<date_time>.xlsx: VA Report enriched, to be used by teams to identify some details about the vulnerability if needed.
* UnprocessedVulnerabilities_<enm_product_set>_<date_time>.xlsx: A set of records for which we cannot process information for various reasons explained in details in **Unprocessed CVE Management** or an empty set if all record can be processed.

### Unprocessed CVE Management

This section list all the conditions to reject a CVE entry belonging to scan tool report file.

The rejected CVEs are recorded in the UnprocessedVulnerabilities_<enm_product_set>_<date_time>.xlsx file, automatically created by CSV generator scripts whenever an error condition preventing CVE information enrichment is found.

The "Reason" column in UnprocessedVulnerability reports information about the issue for rejecting the CVE.

In many cases, the CVE can be managed once a proper corrective action is carried on with manual intervention, after which re-running the CSV generator script the UnprocessedVulnerability file can be removed and all CVE JIRA tickets opened. For this reason is strongly recommended to look at the content of UnprocessedVulnerability file every time it is generated.

To note the layout of the UnprocessedVulnerability file is in two or one sheets depending on unprocessed data found:

* **MAIN** sheet is all reasons except XRAY IDs data.
* **XRAY** sheet is for all data with XRAY ID.

| | Reason To Discard | Corrective Action | Description |
|---|---------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1 | Inconsistent number of value on 'FoundIn', 'Rpm Package, 'Package Paths' cells. | NO CORRECTIVE ACTION.<br>- Scan tools error?<br>- Error in merging the 3 scan tools information? | In case scan tools input detects the same CVE, found by different tools,<br>is recorded in a unique row with hashtag (#) to separate different info about RPM Package and Package Paths columns,<br>according to this tool sequence: trivy # grype # x-ray with reference to the order of columns "Found in..."<br>It is not mandatory the presence of all the 3 tools, one of these may be missing.<br>But, if RPM Package and Package Paths does not contain the same number of hashtag separators as the tools finding that CVE, then the item is considered invalid and unprocessed.|
| 2 | VA report: Inconsistent number of pipe separators                               | NO CORRECTIVE ACTION.<br>- Scan tools error?<br>- Error in merging the 3 scan tools information? | In scan tools input report a CVE entry, coming from a single scan tool,<br>  can collect several RPM Package and Package Paths . In this case they are separated by pipe ("\|")<br> But, if RPM Package and Package Paths does not contain the same number of pipe separators,<br> then the item is considered invalid and unprocessed.|
| 3 | VA report: Empty value on 'Found in ' column  | NO CORRECTIVE ACTION.<br>- Scan tools error?<br>- Error in merging the 3 scan tools information?  | The cells of the CVE in "Found In" column is empty. It must be defined the tool (one or more) that detected the CVE |
| 4 | VA report: Invalid CVE/VID or both            | NO CORRECTIVE ACTION.<br><br> We have not identified any corrective action (might be can be objective of an improvement)<br> because this use case represents an ambiguous situation where we don't know how any criteria to choose as a valid CVE,<br> when we have two different value or a use case where it is not possible at all to identify a CVE id  | CVE information can be taken from CVE-REF or VID column in scan tools repo.<br>If both columns contains unusable or ambiguous values,<br>  the row the CVE refers to is removed from the report to process and added  to  unprocessed file.<br>That's in order to open the JIRA ticket with a proper reference to the vulnerability issue found.<br><br>AND \| CVE_REF == 'None' \| CVE_REF contains "\|" VulnerabilityID == 'None'  \| unprocessed \| unprocessed VulnerabilityID contains "\|"  \| unprocessed \| unprocessed<br><br>For example:<br>- CVE=VID=None (invalid)<br>- CVE=None and VID = vid_1 \| vid_2 (ambiguous)<br>- VID=None and CVE = cve_1 \| cve_2 (ambiguous)<br>- CVE=cve_1 \|cve_2 and VID= vid_1 \| vid_2 (ambiguous) |
| 5 | VA report: Invalid Image Name | NO CORRECTIVE ACTION.<br>- Scan tools error?<br>- Error in merging the 3 scan tools information?| If Image name is one of these cases: ['None', 'None\|', 'None\|\|', 'None\|\|None'] then the item is considered invalid and unprocessed. |
| 6 | Missing Team Name on Jira     | The row is discarded in two possible use cases:<br> 1. JIRA DB not aligned with TI DB <br> 2. Team name missing in TI DB<br>To solve the issue:<br> 1. Ask to team responsible for JIRA to add the required value to their DB taking care to use the same name and upper/lowercase letters<br> 2. Ask to add the missing team name to TI table. After that it is required to ask JIRA team to align their DB to TI one.<br>Please consider, as far as we know, the TI DB is the master DB and JIRA DB is aligned to it periodically.<br>So a missing value in TI DB should be missing also in JIRA DB, but adding it to JIRA is not enough | The identified team name responsible of the CXP/Image name where the CVE was detected doesn't correspond to any team name in JIRA database.<br>That's deals to JIRA vulnerability ticket creation failure and so the CVE is unprocessed  |
| 7 | Missing Requirement Area on Jira  | Ask to team responsible for JIRA to add the required value to their DB taking care to use the same name and upper/lowercase letters | The identified team name responsible of the CXP/Image name where the CVE was detected doesn't correspond to any team name in JIRA database.<br>That's deals to JIRA vulnerability ticket creation failure and so the CVE is unprocessed |
| 8 | Unknown/missing responsible Team and/or RA  | The issue is mainly due to the lack of a CXP and/or the image name in input tables. If so:<br>- Ask to add the missing CXP (if any) to PRM assigning it the responsible team name. <br>Once done re-run the script for updating CXP table file and verify the CVE is added to the generated csv file<br>- If no CXP is available, add manually at least the image name (if missing) to the SG mapping table,<br>look if you can find any reference to any team for that image name in PRM otherwise ask for adding it to PRM to CNA.<br>Once done re-sun script and verify the CVE is added to the generated csv file | Whenever is not possible to identify in CXP table or SG mapping table a valid team or RA for both the image name/CXP the CVE refers to.<br>As a consequence the CVE can't be addressed to any team and no JIRA vulnerability ticket can be opened.  |
| 9 | XRAY-ID Vulnerability | NO CORRECTIVE ACTION. | For when there is XRAY Vulnerability with only XRAY-ID found and no corresponding CVE-ID found in the XRAY Report. |
