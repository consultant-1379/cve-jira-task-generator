"""
Calculate difference from 2 VA and 2 JIRA report file
"""
import sys
import os
import pandas as pd

sys.path.insert(1, os.path.dirname(__file__) + "/../python_script")
import lib.utility_lib as Util  # noqa: E402

EXCLUDE_VA_REPORT_COLUMNS = [
    'Team', 'RA', 'Image Version', 'Package Version', 'Package Paths',
    'VulnerabilityID', 'Fixed Versions', 'Image Path', 'Additional Info',
    'Rpm Version', 'Found in'
]
EXCLUDE_JIRA_REPORT_COLUMNS = [
    'Description', 'Team name', 'RA', 'Found in release', 'Tool',
    'Vulnerability description'
]

WARNING_MESSAGE = f"""
WARNING!: report difference is calculated row by row on all columns value.
If a column is added or the format of the column is modified, the result will
includes these additional rows as changed.

The excluded columns defined for VA report are:

    {EXCLUDE_VA_REPORT_COLUMNS}

and for Jira report are:

    {EXCLUDE_JIRA_REPORT_COLUMNS}
"""

REPORT_FOLDER = "./reports/"
JIRA_PREFIX_NAME = REPORT_FOLDER + "jira_"
VA_PREFIX_NAME = REPORT_FOLDER + "va_"
NEW_ROWS_SUFFIX = "new_rows.xlsx"
REMOVED_ROWS_SUFFIX = "removed_rows.xlsx"
COMMON_ROWS_SUFFIX = "common_rows.xlsx"

# ------------------------- MAIN------------------------------
if sys.version_info.major < 3 or pd.__version__ < "1.1.5":
    print("""\
WARNING! Script running with python version minor of 3 or pandas version
minor of 1.1.5, it is not guaranteed to work properly.
""")

# Check argument numbers
if len(sys.argv) != 5:
    print(f"""\
ERROR on parameters!!

The script calculate the difference between 2 VA report, and between 2 JIRA
report file.
It produce 3 different files containing: new, removed and common rows from the
compared files.

Usage: theScript <new VA report> <old VA report> <new Jira report> \
<old Jira report>

Example:
    python {sys.argv[0]} cENM-va-report-for-jira_22.14.xlsx \
cENM-va-report-for-jira_22.13.xlsx \
cENM-cve-jira-csv_22.14.xlsx \
cENM-cve-jira-csv_22.13.xlsx
""")
    sys.exit(0)

print(WARNING_MESSAGE)

# Load va_enhanced_report files
df_new_va = Util.get_df_from_spreadsheet_file(sys.argv[1])
df_prev_va = Util.get_df_from_spreadsheet_file(sys.argv[2])

# Load csv jira report files
df_new_jira = Util.get_df_from_spreadsheet_file(sys.argv[3])
df_prev_jira = Util.get_df_from_spreadsheet_file(sys.argv[4])

# Calculate diff of va_enhanced_report generated
df_new_va_rows = Util.df_diff(df_new_va, df_prev_va, 'left', True,
                              EXCLUDE_VA_REPORT_COLUMNS)
df_removed_va_rows = Util.df_diff(df_new_va, df_prev_va, 'right', True,
                                  EXCLUDE_VA_REPORT_COLUMNS)
df_common_va_rows = Util.df_diff(df_new_va, df_prev_va, 'inner', True,
                                 EXCLUDE_VA_REPORT_COLUMNS)

# Calculate diff of csv jira report generated
df_new_jira_rows = Util.df_diff(df_new_jira, df_prev_jira, 'left', True,
                                EXCLUDE_JIRA_REPORT_COLUMNS)
df_removed_jira_rows = Util.df_diff(df_new_jira, df_prev_jira, 'right', True,
                                    EXCLUDE_JIRA_REPORT_COLUMNS)
df_common_jira_rows = Util.df_diff(df_new_jira, df_prev_jira, 'inner', True,
                                   EXCLUDE_JIRA_REPORT_COLUMNS)

# Create output folder
Util.create_working_dir_and_remove_tree_if_exists(REPORT_FOLDER, False)

# Save va report files
Util.write_sheet_to_excel(VA_PREFIX_NAME + NEW_ROWS_SUFFIX, df_new_va_rows)
Util.write_sheet_to_excel(VA_PREFIX_NAME + REMOVED_ROWS_SUFFIX,
                          df_removed_va_rows)
Util.write_sheet_to_excel(VA_PREFIX_NAME + COMMON_ROWS_SUFFIX,
                          df_common_va_rows)

# Save jira report files
Util.write_sheet_to_excel(JIRA_PREFIX_NAME + NEW_ROWS_SUFFIX, df_new_jira_rows)
Util.write_sheet_to_excel(JIRA_PREFIX_NAME + REMOVED_ROWS_SUFFIX,
                          df_removed_jira_rows)
Util.write_sheet_to_excel(JIRA_PREFIX_NAME + COMMON_ROWS_SUFFIX,
                          df_common_jira_rows)

print(f"\nGenerated report file: {VA_PREFIX_NAME}*")
print(f"Generated report file: {JIRA_PREFIX_NAME}*\n")
